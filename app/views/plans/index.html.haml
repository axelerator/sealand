%p#notice= notice
- content_for(:sidebar) do
  .form-actions
    = link_to 'New Workshop', new_workshop_path, :class => 'btn btn-primary'
    = link_to 'New Plan', new_plan_path, :class => 'btn'
  = render "shared/list_plans"

#map{"style"=>"height:600px; width: 100%;"}

- matlocations = @materials.map{|mat| {'id'=>mat.id, 'name'=>mat.name, 'locations'=>mat.locations.map(&:attributes)} }.to_json
- workshops = @workshops.to_json

:javascript
  var materials = #{matlocations};
  var workshops = #{workshops};
  var map, layerMapQuest, layerAerial;
  function init(){
    OpenLayers.ProxyHost="/proxy/?url=";
    map = new OpenLayers.Map('map');
    
    layerMapQuest = new OpenLayers.Layer.OSM("MapQuest Open", [
                     "http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.jpg",
                     "http://otile2.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.jpg",
                     "http://otile3.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.jpg",
                     "http://otile4.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.jpg"
                    ]);

    layerAerial = new OpenLayers.Layer.OSM("Aerial", [
                     "http://oatile1.mqcdn.com/tiles/1.0.0/sat/${z}/${x}/${y}.jpg",
                     "http://oatile2.mqcdn.com/tiles/1.0.0/sat/${z}/${x}/${y}.jpg",
                     "http://oatile3.mqcdn.com/tiles/1.0.0/sat/${z}/${x}/${y}.jpg",
                     "http://oatile4.mqcdn.com/tiles/1.0.0/sat/${z}/${x}/${y}.jpg"
                  ]);

    map.addLayer(layerMapQuest);
    map.addLayer(layerAerial);
    map.setCenter(new OpenLayers.LonLat(0, 0), 0);

    var workshopsMarker = new OpenLayers.Layer.Markers( "Workshops" );
    var materialsMarker = new OpenLayers.Layer.Markers( "Marerials" );
    map.addLayer(workshopsMarker);
    map.addLayer(materialsMarker);

    var size = new OpenLayers.Size(21,25);
    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
    workshops.forEach( function(workshop,i) {
      var icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker-blue.png',size,offset);
      var lonLat = new OpenLayers.LonLat(workshop.lng, workshop.lat).transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            map.getProjectionObject() // to Spherical Mercator Projection
          );
      var marker = new OpenLayers.Marker( lonLat, icon );
      marker.events.register("mousedown", marker, function() {
        map.addPopup(new OpenLayers.Popup.Anchored("wor"+workshop.id,lonLat,new OpenLayers.Size(90,50),workshop.name,icon,true,function() { this.destroy(); }));
      });
      workshopsMarker.addMarker(marker);
    });

    var size = new OpenLayers.Size(16,20);
    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
    materials.forEach( function(material,i) {
      material.locations.forEach( function(location,i) {
        var icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker-gold.png',size,offset);
        var lonLat = new OpenLayers.LonLat(location.longitude, location.latitude).transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            map.getProjectionObject() // to Spherical Mercator Projection
          );
        var marker = new OpenLayers.Marker( lonLat, icon );
        marker.events.register("mousedown", marker, function() {
          map.addPopup(new OpenLayers.Popup.Anchored("mat"+material.id,lonLat,new OpenLayers.Size(90,50),material.name,icon,true,function() { this.destroy(); }));
        });
        materialsMarker.addMarker(marker);
      });
    });

    map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.addControl(new OpenLayers.Control.MousePosition({'prefix':'Longitude: ','separator':'<br/>Latitude: &nbsp; ','numDigits':3,"displayProjection":new OpenLayers.Projection("EPSG:4326")}));
    map.zoomToMaxExtent();
    map.zoomIn( map.getZoom() + 1 );
    //map.zoomIn(5);
  }
